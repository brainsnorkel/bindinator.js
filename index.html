<!-- Bind-O-Matic.js Copyright (c) 2016 Tonio Loewald -->
<head>
	<title>Bind-O-Matic</title>
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.5.1/themes/prism-okaidia.css">
	<link rel="stylesheet" type="text/css" href="bom.css">
</head>
<body data-event="keydown(alt-meta-KeyK):demo.alertKeystroke;keydown(alt-Space):demo.fullscreen">
	<div class="layout">
		<div class="header">
			<h1>Bind-O-Matic.js</h1>
		</div>
		<div class="three_col">
			<div class="nav">
				<h3>Documentation</h3>
				<div data-component="list">
					<div 
						class="loadable"
						data-list="source_files" 
						data-bind="text=.name;attr(data-path)=.path"
						data-event="mouseup:demo.showDocs"
					>
						File Name
					</div>
				</div>
				<h3>Components</h3>
				<div data-component="list">
					<div
						class="loadable "
						data-list="components"
						data-bind="text=.name;attr(data-path)=.path"
						data-event="mouseup:demo.loadComponent"
					>
						File Name
					</div>
				</div>
				<h3>Tests</h3>
				<a target="_blank" href="tests.html">Unit Tests</a>
				<h3>Project</h3>
				<a target="_blank" href="https://trello.com/b/0OBL4IjC/bind-o-matic">Trello</a>
			</div>
			<div class="content">
				<h2 style="text-align: right;" id="title"></h2>
				<div id="example"></div>
				<div><pre><code style="font-size: 12px; white-space: pre-wrap;" id="source-code" class="language-markup"></code></pre></div>
			</div>
		</div>
		<div class="footer">
			<div>
				&copy; 2016 Tonio Loewald | <a href="http://loewald.com">loewald.com</a> | <a href="LICENSE.txt">License</a>
			</div>
		</div>
	</div>
	<script src="require.js"></script>
	<script src="bom.js"></script>
	<!--
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jshint/2.9.3/jshint.min.js"></script>
	-->
	<script>
		var title = BOM.id('title');
		var element = BOM.id('example');
		var source_code = BOM.id('source-code');

		function markCurrent(doc) {
			BOM.find('.current').forEach(elt => {
				elt.classList.remove('current');
			});
			const current = BOM.findOne('[data-path="' + doc + '"]');
			if (current) {
				current.classList.add('current');
			}
		}

		BOM.register('demo', {
			showDocs: function(evt) {
				if (evt.target.matches('.current')) {
					return;
				}
				window.location.hash = 'source=' + evt.target.getAttribute('data-path');
			},
			loadComponent: function(evt) {
				if (evt.target.matches('.current')) {
					return;
				}
				window.location.hash = 'component=' + evt.target.getAttribute('data-path');
			},
			alertKeystroke: evt => alert(BOM.keystroke(evt)),
			fullscreen: () => {
				console.log('toggling fullscreen');
				if (!element.matches('.fullscreen')) {
					element.classList.add('fullscreen');
				} else {
					element.classList.remove('fullscreen');
				}
			}
		});
		BOM.component('hello', 'components/hello');

		BOM.json('source-files.json')
		   .then(data => BOM.register('source_files', data))
		   .then(() => BOM.json('components.json'))
		   .then(data => {
		   		data.sort((a, b) => a.name.toLocaleLowerCase() > b.name.toLocaleLowerCase() ? 1 : -1);
		   		BOM.register('components', data);
		 		})
		   .then(update);

		var last_component_path;
		function update() {
			var component_path = window.location.hash.substr(1).split('?')[0];
			if(component_path === last_component_path) {
				console.warn('ignoring hash change within component');
				return;
			}
			last_component_path = component_path;

			markCurrent(component_path.split('=').pop());

			var pairs = component_path.split('&').map(pair => {
				var [key, value] = pair.split('=');
				return {key, value};
			});
			var {key, value} = pairs[0];
			if (key) {
				BOM.empty(element);
				BOM.hide(source_code.closest('div'));
				switch (key) {
					case 'source':
						title.textContent = value;
						BOM.component('file-viewer', 'components/file-viewer').then(viewer => {
							BOM.insertComponent(viewer, element, {url: value});
						});
						break;
					case 'component':
						BOM.component(value, 'components/' + value)
							 .then(component => {
							 		title.textContent = value.split('/').pop() + '.component.html';
							 		source_code.textContent = component._source.replace(/\t/g, '  ');
							 		require.lazy("https://cdnjs.cloudflare.com/ajax/libs/prism/1.5.1/prism.min").then(() => {
							 			Prism.highlightElement(source_code);
							 			BOM.show(source_code.closest('div'));
							 		});
							 		BOM.insertComponent(component, element);
							 });
						break;
				} 
			} else {
				// FIXME don't do this, behave as though there's a default hash so history behaves nicely
				BOM.trigger('mouseup', BOM.findOne('.loadable'));
			}
		}

		window.addEventListener('hashchange', update);
	</script>
</body>