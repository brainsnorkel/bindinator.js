<!--
# mondrian

A component for messing around with the `mondrian.js` layout library.
-->
<style>
  .mondrian {
    background: rgba(0,0,0,0.5);
    position: relative;
    overflow: hidden;
  }
  .mondrian > * {
    object-fit: cover;
    border-radius: 0.5px; /* without this, object-fit is broken in Chrome */
    position: absolute;
    transition: 0.5s ease-out;
  }

  .mondrian-label {
    padding: 4px;
    display: inline-block;
  }
</style>
<div
  class="mondrian"
  data-bind="style(height)=_component_.container_height"
  data-event="click:_component_.focus"
>
  <video src="test/video/portrait1.mov" autoplay=true loop=true></video>
  <video src="test/video/portrait2.mov" autoplay=true loop=true></video>
  <video src="test/video/portrait3.mov" autoplay=true loop=true></video>
  <video src="test/video/landscape1.mov" autoplay=true loop=true></video>
  <div style="overflow: hidden">
    <video src="test/video/portrait3.mov" style="display: none" autoplay=true loop=true></video>
    <video
      style="width: 100%; height: 100%; object-fit: cover;"
      src="test/video/landscape2.mov"
      autoplay=true
      loop=true
    ></video>
  </div>
  <video src="test/video/landscape3.mov" autoplay=true loop=true></video>
  <img src="test/portraits/tentacle.png">
  <img src="test/portraits/weasel.png">
  <canvas width="128" height="128"></canvas>
</div>
<button class="hide" data-event="click:_component_.hide_random">Hide Random</button>
<button class="show" data-event="click:_component_.show_random">Show Random</button>
<label class="mondrian-label">
  <input class="random_changes" type="checkbox" checked>Randomly add/remove/focus items
</label>
<label class="mondrian-label">
  <select
    data-bind="value=_component_.desired_aspect_ratio"
  >
    <option value="0.33">3:1 Extreme Portrait</option>
    <option value="0.67">3:2 Portrait</option>
    <option value="1" selected>Square</option>
    <option value="1.33">4:3 Landscape</option>
    <option value="1.78">16:9 Widescreen</option>
    <option value="2">2:1 Extreme Widescreen</option>
    <option value="4">4:1 Extreme Widescreen</option>
  </select> Desired Aspect Ratio
</label>
  <select
    data-bind="value=_component_.container_height"
  >
    <option value="800px">Tall</option>
    <option value="400px">Normal</option>
    <option value="200px" selected>Wide</option>
  </select> Container Shape
</label>
<label class="mondrian-label">
  <input
    type="checkbox"
    data-bind="checked=_component_.focus_enabled"
    data-event="change:_component_.change_focus_enabled"
  >
  Focus Enabled (click to toggle focus on elements)
</label>
<label class="mondrian-label">
  <input type="checkbox" data-bind="checked=_component_.letterbox_enabled">
  Letterbox Enabled
</label>
<label class="mondrian-label" data-bind="show_if=_component_.letterbox_enabled">
  <input type="range" min="1" max="2" step="0.05" data-bind="value=_component_.letterbox"
  >
  (<span data-bind="fixed(2)=_component_.letterbox"></span>) Letterbox Threshold
</label>
<script>
/* jshint latedef:false */
/* global find, findOne, register, b8r, on, get */

  const mondrian = await import('../lib/mondrian.js');
  const resize = await import('../lib/resize.js');

  const visible = () => find('.mondrian > *').filter(div => !div.matches('.hidden'));
  const hidden = () => find('.mondrian > .hidden');
  const random_changes = findOne('.random_changes');
  const canvas = findOne('canvas');

  on('change,update,resize', '_component_.update');

  /* test canvas */
  const g = canvas.getContext('2d');
  g.fillStyle = 'red';
  g.fillRect(0,0,64,64);
  g.fillStyle = 'green';
  g.fillRect(64,0,64,64);
  g.fillStyle = 'blue';
  g.fillRect(0,64,64,64);
  g.fillStyle = 'yellow';
  g.fillRect(64,64,64,64);

  const update = () => requestAnimationFrame(() => {
    mondrian.arrange_with_focus(
      visible(),
      {
        aspect_ratio: get('desired_aspect_ratio'),
        letterbox: get('letterbox_enabled') && get('letterbox')
      }
    );
  });

  const container = findOne('.mondrian');
  resize.relayTo(container);

  function pick_random(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function random_behavior () {
    if(random_changes.checked) {
      if(hidden().length === 0) {
        hide_random();
      } else if (visible().length === 0) {
        show_random();
      } else {
        switch (Math.floor(Math.random() * 4)) {
          case 0:
            hide_random();
            break;
          case 1:
            show_random();
            break;
          case 3:
            pick_random(visible()).click();
            break;
        }
      }
    }
  }

  const {domInterval} = await import('../lib/dom-timers.js');
  domInterval(container, random_behavior, 2000);

  function hide_random () {
    const elt = pick_random(visible());
    if (elt) {
      elt.classList.add('hidden');
      b8r.trigger('change', container);
    }
  }

  function show_random () {
    const elt = pick_random(hidden());
    if (elt) {
      elt.classList.remove('hidden');
      b8r.trigger('change', container);
    }
  }

  register ({
    hide_random,
    show_random,
    update,
    container_height: '400px',
    desired_aspect_ratio: 1,
    focus_enabled: true,
    letterbox_enabled: true,
    letterbox: 1.25,
    change_focus_enabled: () => {
      if (! get('focus_enabled')) {
        find('.mondrian-focus').forEach(elt => elt.classList.remove('mondrian-focus'));
        update();
      }
    },
    focus: evt => {
      if (! get('focus_enabled')) {
        return;
      }
      const target = evt.target.closest('.mondrian > *');
      if (target && target.classList.contains('mondrian-focus')) {
        target.classList.remove('mondrian-focus');
      } else {
        find('.mondrian-focus').forEach(elt => elt.classList.remove('mondrian-focus'));
        if (target) target.classList.add('mondrian-focus');
      }
      update();
    }
  });

  update();
</script>
