<!-- bindinator.js Copyright (c) 2016 Tonio Loewald -->
<style>
	.annotation {
		position: absolute;
		color: white;
		background-color: rgba(0,0,0,0.6);
		border-radius: 4px;
		box-shadow: 0.5px 1.5px 3px rgba(0,0,0,0.25);
	}

	.annotation > div > * {
		padding: 4px 12px;
	}

	.annotation > div > header,
	.annotation > div > footer {
		padding: 6px 12px;
	}

	.annotation:before {
		position: absolute;
		display: block;
		border: solid transparent 8px;
		border-bottom-color: rgba(0,0,0,0.6);
		content: '';
		width: 0;
		height: 0;
		top: -16px;
		left: 50%;
		margin-left: -8px;
	}
</style>
<div data-children data-event="show,change:_component_.updatePosition">
	Annotation
</div>
<script>
	component.classList.add('annotation');
	function position(element) {
		var pos = { x:0, y:0 };
		while (element) {
			pos.x += element.offsetLeft;
			pos.y += element.offsetTop;
			element = element.offsetParent;
		}
		return pos;
	}
	function scrollOffset(element) {
		var offset = { x:0, y:0 };
		while (element && element.scrollLeft !== undefined) {
			offset.x += element.scrollLeft;
			offset.y += element.scrollTop;
			element = element.parentNode;
		}
		return offset;
	}
	function subtractPoint(p, q) {
		return {x: p.x - q.x, y: p.y - q.y};
	}
	function addPoint(p, q) {
		return {x: p.x + q.x, y: p.y + q.y};
	}
	console.log('annotation', data);
	data = data || {};
	if (!data.target) {
		data.target = component.parentElement;
	}

	if (data.content) {
		const container = findOne('[data-children]');
		b8r.empty(container);
		container.appendChild(data.content);
	}

	function updatePosition() {
		var target_pos = subtractPoint(position(data.target), scrollOffset(data.target));
		component.style.left = (target_pos.x + data.target.clientWidth / 2 - component.clientWidth / 2) + 'px';
		component.style.top = (target_pos.y + data.target.clientHeight + 4) + 'px';	
		console.log('position updated');
	}

	updatePosition();

	return { updatePosition };
</script>